<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>人生重开模拟器</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: transparent;
            min-height: 100vh;
        }
        #game-container {
            max-width: 365px;
            max-height: 536px;
            border-radius: 15px;
            overflow-y: auto;
            padding: 12px;
            margin: 5px auto;
        }
        h2 {
            color: #000000;
            text-align: center;
            font-size: 28px;
            margin: 5px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        h3 {
            text-align: center;
        }
        .attribute {
            margin: 0px 0px 5px 30%;
            display: flex;
            align-items: center;
        }
        .attribute label {
            width: 40px;
            color: #2c3e50;
            font-weight: bold;
        }
        input[type="number"] {
            width: 60px;
            padding: 8px;
            border: 2px solid #3498db;
            border-radius: 5px;
            font-size: 16px;
            margin-left: 10px;
        }
        button {
            background: linear-gradient(45deg, #e67e22, #d35400);
            color: white;
            padding: 10px 10px 10px 10px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            display: block;
            margin: 5px auto;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.2);
        }
        #status {
            background: #ecf0f1;
            padding: 5px;
            border-radius: 10px;
            margin: 10px 0 0 0;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0px;
        }
        #status p {
            margin: 8px 0;
            color: #34495e;
        }
        .highlight {
            color: #c0392b;
            font-weight: bold;
        }
        #events {
            background: #fff9eb;
            border: 2px solid #f1c40f;
            border-radius: 10px;
            padding: 5px;
            margin: 5px 0 0 0;
            max-height: 320px;
            overflow-y: auto;
        }
        .event p {
            margin: 5px 0;
            color: #2c3e50;
        }
        .hidden {
            display: none;
        }
        #summary {
            line-height: 1.8;
            font-size: 16px;
            color: #34495e;
        }
    </style>
    <style>
        /* 天赋选择容器调整为网格布局 */
        #talent-selection {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
            padding: 10px;
        }

        .talent-card {
            width: auto;
            position: relative;
            padding: 3px;
            border: 2px solid #9e9e9e;
        }
        .talent-card h4 {
            padding: 0;
            margin: 0;
        }
        .talent-card p {
            padding: 0;
            margin: 0;
        }
        .talent-card.disabled {
            opacity: 0.6;
            background: rgba(0,0,0,0.2);
            cursor: not-allowed;
        }
        .selected-counter {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #e67e22;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- 保持原有HTML结构不变，仅修改样式 -->
    <div id="game-container">
        <div id="start-screen">
            <h2>人生重开模拟器</h2>
            <p style="text-align: center; color: #7f8c8d; margin-bottom: 20px;">分配你的初始属性（总点数20）</p>
            <div class="attribute">
                <label>颜值:</label>
                <input type="number" id="looks" min="0" max="20" value="5">
            </div>
            <div class="attribute">
                <label>智力:</label>
                <input type="number" id="intelligence" min="0" max="20" value="5">
            </div>
            <div class="attribute">
                <label>体质:</label>
                <input type="number" id="health" min="0" max="20" value="5">
            </div>
            <div class="attribute">
                <label>家境:</label>
                <input type="number" id="wealth" min="0" max="20" value="5">
            </div>
            </br>
            <button onclick="startGame()">开始新人生</button>
        </div>
        <div id="talent-screen" class="hidden">
            <h3>选择你的初始天赋（10选3）</h3>
            <div id="talent-selection"></div>
            <div style="text-align:center;margin:15px 0">
                已选择 <span id="selectedCount">0</span>/3 个天赋
            </div>
            <button onclick="confirmTalent()" style="margin-top:10px">确认选择</button>
        </div>
        <div id="game-screen" class="hidden">
            <h2>人生轨迹</h2>
            <div id="status">
                <p>年龄: <span id="age" class="highlight">0</span> 岁</p>
                <p>颜值: <span id="current-looks" class="highlight">0</span></p>
                <p>智力: <span id="current-intelligence" class="highlight">0</span></p>
                <p>体质: <span id="current-health" class="highlight">0</span></p>
                <p>家境: <span id="current-wealth" class="highlight">0</span></p>
            </div>
            <button onclick="nextYear()">进入下一年</button>
            <div id="events"></div>
        </div>
        <div id="end-screen" class="hidden">
            <h2>人生总结</h2>
            <p id="summary"></p>
            <button onclick="location.reload()">再活一次</button>
        </div>
    </div>

    <script>
        // 天赋库（示例包含15个天赋，实际可扩展）
        const talentPool = [
            {
                name: "商业奇才",
                desc: "初始财富+4，智力+2",
                req: { wealth: 6 },
                effects: { wealth: 4, intelligence: 2 }
            },
            {
                name: "运动健将",
                desc: "体质+3，颜值-1",
                effects: { health: 3, looks: -1 }
            },
            {
                name: "天选之人",
                desc: "全属性+1",
                req: { intelligence: 5, looks: 5 },
                effects: { health: 1, looks: 1, intelligence: 1, wealth: 1 }
            },
            {
                name: "书香门第",
                desc: "智力+3，获得奖学金",
                req: { wealth: 4 },
                effects: { intelligence: 3, wealth: 2 }
            },
            {
                name: "科技新贵",
                desc: "20岁时财富大幅增加",
                req: { intelligence: 7 },
                effects: { _special: (p) => { if(p.age === 20) p.wealth += 8 } }
            },
            {
                name: "不老容颜",
                desc: "颜值锁定不低于10",
                effects: { _special: (p) => { p.looks = Math.max(p.looks, 10) } }
            },
            {
                name: "冒险精神",
                desc: "随机获得3-5点属性",
                effects: {
                    _special: (p) => {
                        const attrs = ['looks', 'intelligence', 'health', 'wealth'];
                        for(let i=0; i<3; i++){
                            const attr = attrs[Math.floor(Math.random()*attrs.length)];
                            p[attr] += 1 + Math.floor(Math.random()*2);
                        }
                    }
                }
            },
            {
                name: "理财达人",
                desc: "每年有30%概率财富+1",
                effects: {
                    _special: (p) => {
                        p._annualEvents.push({
                            condition: () => Math.random() < 0.3,
                            effect: { wealth: 1 }
                        })
                    }
                }
            },
            {
                name: "厄运缠身",
                desc: "属性-2但可选4个天赋",
                effects: {
                    health: -2,
                    _special: () => { maxSelectCount = 4 } // 特殊效果
                }
            },
            {
                name: "幸运儿",
                desc: "奇遇概率翻倍",
                effects: { _special: (p) => p.luck = 2 }
            },
            {
                name: "武道传人",
                desc: "体质+4，智力-2",
                req: { health: 5 },
                effects: { health: 4, intelligence: -2 }
            },
            {
                name: "社交达人",
                desc: "颜值+2，30岁时财富+3",
                effects: {
                    looks: 2,
                    _special: (p) => {
                        p._annualEvents.push({
                            age: 30,
                            effect: { wealth: 3 }
                        })
                    }
                }
            },
            {
                name: "天煞孤星",
                desc: "全属性+3但寿命减半",
                effects: {
                    health: 3, looks: 3, intelligence: 3, wealth: 3,
                    _special: (p) => p.lifespan = Math.floor(p.lifespan/2)
                }
            },
            {
                name: "重生者",
                desc: "保留10%上轮属性",
                effects: {
                    _special: (p) => {
                        if(prevRunAttributes){
                            p.looks += Math.round(prevRunAttributes.looks * 0.1);
                            p.intelligence += Math.round(prevRunAttributes.intelligence * 0.1);
                            p.health += Math.round(prevRunAttributes.health * 0.1);
                            p.wealth += Math.round(prevRunAttributes.wealth * 0.1);
                        }
                    }
                }
            },
            {
                name: "时间管理大师",
                desc: "每年额外获得1点属性",
                effects: {
                    _special: (p) => {
                        p._annualEvents.push({
                            effect: () => {
                                const attr = ['looks', 'intelligence', 'health', 'wealth'][
                                    Math.floor(Math.random()*4)];
                                p[attr]++;
                            }
                        })
                    }
                }
            }
        ];
        let selectedTalents = [];
        let maxSelectCount = 3; // 正常可选3个
        let currentTalents = []; // 当前随机到的天赋

        // 修改后的天赋选择函数
        function showTalentSelection() {
            const container = document.getElementById('talent-selection');
            container.innerHTML = '';
            selectedTalents = [];
            document.getElementById('selectedCount').textContent = 0;

            // 随机选取10个不重复的天赋
            currentTalents = getRandomTalents(10);

            currentTalents.forEach((talent, index) => {
                const card = document.createElement('div');
                card.className = 'talent-card';
                card.innerHTML = `
                    <h4>${talent.name}</h4>
                    <p>${talent.desc}</p>
                    ${talent.req ? `<div class="talent-requirements">需求：${formatRequirements(talent.req)}</div>` : ''}
                `;

                // 检查是否满足条件
                const meetsReq = checkTalentRequirements(talent);
                if(!meetsReq) {
                    card.classList.add('disabled');
                } else {
                    card.onclick = () => toggleTalentSelection(index, card);
                }

                container.appendChild(card);
            });
        }

        function formatRequirements(req) {
            return Object.entries(req).map(([k, v]) => `${attributeMap[k]}≥${v}`).join('，');
        }

        function getRandomTalents(num) {
            // 洗牌算法随机选择
            const shuffled = [...talentPool].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, num);
        }

        function checkTalentRequirements(talent) {
            if(!talent.req) return true;
            return Object.entries(talent.req).every(([attr, value]) => player[attr] >= value);
        }

        function toggleTalentSelection(index, card) {
            const talent = currentTalents[index];

            if(selectedTalents.includes(index)) {
                // 取消选择
                selectedTalents = selectedTalents.filter(i => i !== index);
                card.classList.remove('selected');
                card.querySelector('.selected-counter')?.remove();
            } else {
                // 检查选择上限
                if(selectedTalents.length >= maxSelectCount) {
                    alert(`最多只能选择${maxSelectCount}个天赋！`);
                    return;
                }
                selectedTalents.push(index);
                const counter = document.createElement('div');
                counter.className = 'selected-counter';
                counter.textContent = selectedTalents.length;
                card.appendChild(counter);
                card.classList.add('selected');
            }

            document.getElementById('selectedCount').textContent = selectedTalents.length;
        }

        // 修改后的确认函数
        function confirmTalent() {
            if(selectedTalents.length < 1) {
                alert("请至少选择1个天赋！");
                return;
            }

            selectedTalents.forEach(index => {
                const talent = currentTalents[index];
                applyTalentEffects(talent);
            });

            // 进入游戏界面
            document.getElementById('talent-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            updateStatus();
        }

        function applyTalentEffects(talent) {
            // 处理常规属性
            Object.entries(talent.effects).forEach(([attr, value]) => {
                if(attr.startsWith('_')) return; // 特殊属性
                player[attr] += value;
            });

            // 处理特殊效果
            if(talent.effects._special) {
                talent.effects._special(player);
            }
        }
        // 属性显示映射
        const attributeMap = {
            looks: '颜值',
            intelligence: '智力',
            health: '体质',
            wealth: '家境'
        };
        // 在player对象中添加辅助属性
        let prevRunAttributes = null; // 用于存储上一局属性
        let maxLifespan = 100; // 初始寿命
        const player = {
            age: -1, // 从-1开始用于出生事件
            gender: '', // 新增性别属性
            looks: 0,
            intelligence: 0,
            health: 0,
            wealth: 0,
            lifespan: maxLifespan,
            luck: 1,
            _annualEvents: [] // 用于存储天赋添加的年度事件
        };
        function startGame() {
            // 获取初始属性值
            const initialLooks = parseInt(document.getElementById('looks').value);
            const initialIntelligence = parseInt(document.getElementById('intelligence').value);
            const initialHealth = parseInt(document.getElementById('health').value);
            const initialWealth = parseInt(document.getElementById('wealth').value);
            // 验证总点数
            const totalPoints = initialLooks + initialIntelligence + initialHealth + initialWealth;
            if (totalPoints !== 20) {
                alert('总点数必须等于20！');
                return;
            }
            // 存储上一局属性用于天赋「重生者」
            prevRunAttributes = {
                looks: player.looks,
                intelligence: player.intelligence,
                health: player.health,
                wealth: player.wealth
            };
            // 初始化玩家属性
            player.age = 0;
            player.looks = initialLooks;
            player.intelligence = initialIntelligence;
            player.health = initialHealth;
            player.wealth = initialWealth;
            // 重置特殊属性
            player.lifespan = 100;  // 基础寿命100岁
            player.luck = 1;        // 初始运气值
            player._annualEvents = [];  // 清空年度事件
            // 切换界面
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('talent-screen').classList.remove('hidden');
            // 显示天赋选择界面
            showTalentSelection();
            // 初始化天赋系统
            selectedTalents = [];
            maxSelectCount = 3;  // 重置可选数量（防止受上一局影响）
            // 初始化性别
            player.gender = Math.random() > 0.5 ? '男孩' : '女孩';
            // 触发出生事件
            setTimeout(() => nextYear(true), 500); // 延迟半秒自动开始
        }
        function updateStatus() {
            document.getElementById('current-looks').textContent = player.looks;
            document.getElementById('current-intelligence').textContent = player.intelligence;
            document.getElementById('current-health').textContent = player.health;
            document.getElementById('current-wealth').textContent = player.wealth;
            document.getElementById('age').textContent = player.age;
        }
        function generateEvent() {
            const events = [];
            const currentYear = player.age + 1; // 当前年龄（出生时为0岁）

            // ================= 性别事件 =================
            const genderEvents = [
                {
                    age: [25, 26, 27, 28],
                    text: function() {
                        const action = player.gender === '男孩' ? '娶' : '嫁';
                        return `${["通过相亲", "自由恋爱"][Math.floor(Math.random()*2)]}${action}了${["同学", "同事", "网友"][Math.floor(Math.random()*3)]}`;
                    },
                    effect: {
                        health: 1,
                        wealth: () => Math.random() > 0.5 ? 2 : -1
                    }
                },
                {
                    condition: () => player.age >= 30 && player.age <= 40,
                    text: function() {
                        const childGender = Math.random() > 0.5 ? '儿子' : '女儿';
                        return `你的${childGender}${["考上重点学校", "生病住院", "叛逆期来临"][Math.floor(Math.random()*3)]}`;
                    },
                    effect: {
                        wealth: -2,
                        health: -1
                    }
                }
            ];

            // ================= 通用随机事件 =================
            const genericEvents = [
                // 健康相关
                {
                    condition: () => player.health < 8,
                    text: "长期熬夜导致身体机能下降",
                    health: -2,
                    intelligence: -1
                },
                {
                    text: "坚持每日锻炼计划",
                    health: 1 + Math.floor(Math.random()*2),
                    looks: 1
                },
                {
                    text: "食物中毒住院治疗",
                    health: -3,
                    wealth: -2
                },

                // 财富相关
                {
                    condition: () => player.wealth > 10,
                    text: "投资理财产品获得收益",
                    wealth: 2 + Math.floor(Math.random()*3)
                },
                {
                    condition: () => player.wealth < 5,
                    text: "经济困难不得不节衣缩食",
                    health: -1,
                    intelligence: -1
                },
                {
                    text: "意外获得遗产继承",
                    wealth: 5 + Math.floor(Math.random()*5)
                },

                // 颜值相关
                {
                    condition: () => player.looks > 12,
                    text: "成为时尚杂志封面人物",
                    looks: 1,
                    wealth: 2
                },
                {
                    text: "尝试新发型" + (Math.random() > 0.5 ? "成功" : "失败"),
                    looks: Math.random() > 0.6 ? 2 : -1
                },

                // 智力相关
                {
                    text: "坚持阅读学习新知识",
                    intelligence: 1 + Math.floor(Math.random()*2)
                },
                {
                    condition: () => player.intelligence > 10,
                    text: "发明专利申请成功",
                    wealth: 3,
                    intelligence: 1
                }
            ];

            // ================= 新增童年事件（0-12岁） =================
            const childhoodEvents = [
                {
                    age: [3, 4],
                    text: function() { return `在${Math.random() > 0.7 ? "公园" : "幼儿园"}展现${["音乐", "绘画", "运动"][Math.floor(Math.random()*3)]}天赋` },
                    effect: {
                        intelligence: 1,
                        looks: Math.random() > 0.5 ? 1 : 0
                    }
                },
                {
                    condition: () => player.health > 8,
                    text: "成为孩子王带领大家玩耍",
                    effect: {
                        health: 1,
                        intelligence: 1
                    }
                },
                {
                    age: 10,
                    text: function() {
                        const subjects = ["数学", "作文", "英语"];
                        const subject = subjects[Math.floor(Math.random()*3)];
                        return `获得${subject}竞赛${Math.random() > 0.6 ? "一等" : "二等"}奖`
                    },
                    effect: {
                        intelligence: 2,
                        wealth: player.wealth > 10 ? 2 : 1
                    }
                }
            ];

            // ================= 新增校园事件（13-22岁） =================
            const schoolEvents = [
                {
                    age: [14, 15],
                    text: function() {
                        const types = {
                            good: ["被选为班长", "获得三好学生"],
                            bad: ["考试作弊被处分", "与同学发生冲突"]
                        };
                        const category = player.intelligence > 10 ? 'good' : 'bad';
                        return types[category][Math.floor(Math.random()*types[category].length)];
                    },
                    effect: () => ({
                        intelligence: player.intelligence > 10 ? 1 : -1,
                        health: -1
                    })
                },
                {
                    age: [18, 19],
                    text: function() {
                        if(player.intelligence > 15) return "保送顶尖大学热门专业";
                        if(player.wealth > 12) return "出国留学深造";
                        return "参加高考" + (Math.random() > 0.5 ? "发挥出色" : "失常");
                    },
                    effect: function() {
                        const result = {
                            intelligence: 2 + Math.floor(Math.random()*2),
                            wealth: -3
                        };
                        if(player.wealth > 15) result.wealth = -1;
                        return result;
                    }
                }
            ];

            // ================= 新增职场事件（23-50岁） =================
            const careerEvents = [
                {
                    condition: () => player.age >= 25 && player.age <= 40,
                    text: function() {
                        const events = {
                            promotion: ["升任项目经理", "成为部门主管"],
                            crisis: ["项目失败被问责", "遭遇职场PUA"]
                        };
                        const successRate = player.intelligence * 0.3 + player.wealth * 0.2;
                        return successRate > 15 ?
                            events.promotion[Math.floor(Math.random()*events.promotion.length)] :
                            events.crisis[Math.floor(Math.random()*events.crisis.length)];
                    },
                    effect: () => ({
                        wealth: Math.random() > 0.5 ? 3 : -2,
                        health: -1
                    })
                },
                {
                    age: [30, 35, 40],
                    text: "考虑职业转型",
                    effect: {
                        intelligence: 2,
                        wealth: -2
                    }
                }
            ];

            // ================= 新增家庭事件 =================
            const familyEvents = [
                {
                    condition: () => player.age >= 25 && Math.random() > 0.7,
                    text: function() {
                        const scenarios = [
                            "与青梅竹马修成正果",
                            "相亲遇到合适对象",
                            "突然奉子成婚"
                        ];
                        return scenarios[Math.floor(Math.random()*scenarios.length)];
                    },
                    effect: {
                        health: 1,
                        wealth: () => player.wealth + (Math.random() > 0.5 ? 2 : -1)
                    }
                },
                {
                    condition: () => player.age >= 30,
                    text: "孩子教育问题引发家庭矛盾",
                    effect: {
                        intelligence: -1,
                        health: -2
                    }
                }
            ];

            // ================= 新增老年事件 =================
            const elderlyEvents = [
                {
                    age: [60, 65],
                    text: function() {
                        const activities = [
                            "参加老年大学",
                            "开始环游世界",
                            "沉迷保健品购买"
                        ];
                        return activities[Math.floor(Math.random()*activities.length)];
                    },
                    effect: () => ({
                        health: Math.random() > 0.4 ? 1 : -1,
                        wealth: Math.random() > 0.6 ? -2 : 0
                    })
                },
                {
                    condition: () => player.age >= 70,
                    text: function() {
                        const status = player.health > 10 ?
                            "保持良好生活习惯" : "多种慢性病缠身";
                        return `${status}，${["定期体检", "需要长期服药"][Math.floor(Math.random()*2)]}`;
                    },
                    effect: {
                        health: player.health > 10 ? 0 : -1
                    }
                }
            ];

            // ================= 新增特殊事件 =================
            const specialEvents = [
                {
                    condition: () => player.looks > 15 && currentYear > 18 && currentYear < 40,
                    text: "被国际品牌选为代言人",
                    looks: 2,
                    wealth: 5
                },
                {
                    condition: () => player.intelligence > 18 && currentYear < 30,
                    text: "获得全额奖学金出国深造",
                    intelligence: 3,
                    wealth: 2
                },
                {
                    condition: () => player.health > 15 && Math.random() > 0.9,
                    text: "打破运动赛事世界纪录",
                    health: 2,
                    wealth: 4
                },
                {
                    condition: () => player.wealth < 3 && currentYear > 25,
                    text: "遭遇电信诈骗损失财产",
                    wealth: -3,
                    health: -2
                },
                {
                    condition: () => player.luck > 1 && Math.random() > 0.9,
                    text: "偶遇贵人改变人生轨迹",
                    effect: {
                        wealth: 3,
                        intelligence: 2
                    }
                },
                {
                    condition: () => player.health > 15 && player.age < 40,
                    text: "被选为运动员参加国际赛事",
                    effect: {
                        health: -3,
                        wealth: 5
                    }
                },
                {
                    text: "时空裂缝事件（属性重置）",
                    rarity: 0.05, // 5%概率触发
                    effect: function() {
                        const attributes = ['looks', 'intelligence', 'health', 'wealth'];
                        attributes.forEach(attr => {
                            player[attr] = Math.floor(Math.random() * 15) + 5;
                        });
                        return { special: true };
                    }
                }
            ];

            // ================= 年龄阶段事件 =================
            // 童年阶段 (0-12岁)
            if(currentYear <= 12) {
                events.push(
                    {
                        age: 4,
                        text: "在幼儿园展现艺术天赋",
                        looks: 1,
                        intelligence: 1
                    },
                    {
                        age: 7,
                        text: "参加少儿智力竞赛获奖",
                        intelligence: 2,
                        wealth: 1
                    },
                    {
                        condition: () => currentYear >= 6 && currentYear <= 12,
                        text: "沉迷电子游戏影响学习",
                        intelligence: -1,
                        health: -1
                    }
                );
            }

            // 青少年阶段 (13-18岁)
            if(currentYear > 12 && currentYear <= 18) {
                events.push(
                    {
                        age: 14,
                        text: "青春期发育带来变化",
                        looks: Math.random() > 0.3 ? 2 : -1,
                        health: 1
                    },
                    {
                        condition: () => player.intelligence > 10,
                        text: "获得全国学科竞赛金奖",
                        intelligence: 2,
                        wealth: 3
                    },
                    {
                        text: "校园霸凌事件影响心理健康",
                        health: -2,
                        intelligence: -1
                    }
                );
            }

            // 成年阶段 (19-30岁)
            if(currentYear > 18 && currentYear <= 30) {
                events.push(
                    {
                        age: 22,
                        text: "大学毕业面临就业选择",
                        wealth: player.intelligence > 12 ? 3 : 1
                    },
                    {
                        age: 25,
                        text: "职场新人压力山大",
                        health: -1,
                        intelligence: 1
                    },
                    {
                        condition: () => Math.random() > 0.7,
                        text: "遇到人生伴侣决定结婚",
                        health: 1,
                        wealth: player.wealth > 15 ? 2 : -1
                    },
                    {
                        text: "参加职业培训提升技能",
                        intelligence: 2,
                        wealth: -1
                    }
                );
            }

            // 中年阶段 (31-50岁)
            if(currentYear > 30 && currentYear <= 50) {
                events.push(
                    {
                        age: 35,
                        text: "晋升为部门主管",
                        wealth: 3,
                        health: -1
                    },
                    {
                        age: 40,
                        text: "中年危机: " + ["创业尝试", "职业转型", "健康预警"][Math.floor(Math.random()*3)],
                        wealth: Math.random() > 0.5 ? 4 : -3,
                        health: -2
                    },
                    {
                        text: "子女教育问题带来压力",
                        intelligence: -1,
                        health: -1
                    },
                    {
                        condition: () => player.wealth > 15,
                        text: "投资房地产获利",
                        wealth: 5 + Math.floor(Math.random()*5)
                    }
                );
            }

            // 老年阶段 (51+)
            if(currentYear > 50) {
                events.push(
                    {
                        age: 60,
                        text: "举办退休告别宴会",
                        health: 1,
                        wealth: -2
                    },
                    {
                        text: "慢性疾病需要长期治疗",
                        health: -2,
                        wealth: -3
                    },
                    {
                        condition: () => player.intelligence > 12,
                        text: "出版个人回忆录",
                        wealth: 2,
                        intelligence: 1
                    },
                    {
                        text: "参加老年大学学习新技能",
                        intelligence: 1,
                        health: 1
                    }
                );
            }

            // ================= 事件处理逻辑 =================
            // 合并所有可能的事件
            const allEvents = []
                .concat(genericEvents)
                .concat(childhoodEvents)
                .concat(schoolEvents)
                .concat(careerEvents)
                .concat(familyEvents)
                .concat(elderlyEvents)
                .concat(specialEvents)
                .concat(events)

            // 处理动态文本和效果
            const processedEvents = allEvents.map(event => {
                // 处理动态文本
                let finalText = event.text;
                if(typeof finalText === 'function') {
                    try {
                        finalText = finalText();
                    } catch (error) {
                        console.error("事件文本生成错误:", error);
                        finalText = "发生了特殊事件";
                    }
                }
                // 处理动态效果
                let finalEffect = event.effect;
                if(typeof finalEffect === 'function') {
                    try {
                        finalEffect = finalEffect();
                    } catch (error) {
                        console.error("事件效果生成错误:", error);
                        finalEffect = {};
                    }
                }
                return {
                    text: finalText,
                    effect: finalEffect,
                    condition: event.condition,
                    age: event.age,
                    rarity: event.rarity || 1
                };
            });

            // 筛选符合条件的事件
            const validEvents = processedEvents.filter(e => {
                // 年龄检查支持数字和数组
                if(e.age !== undefined) {
                    if(Array.isArray(e.age)) {
                        if(!e.age.includes(player.age)) return false;
                    } else if(e.age !== player.age) {
                        return false;
                    }
                }
                // 检查自定义条件
                return !(e.condition && !e.condition());
            });

            // 优先处理固定年龄事件
            const ageSpecific = validEvents.filter(e => e.age !== undefined);
            if(ageSpecific.length > 0) {
                return ageSpecific[Math.floor(Math.random()*ageSpecific.length)];
            }

            // 随机选择其他事件
            return validEvents.length > 0
                ? validEvents[Math.floor(Math.random()*validEvents.length)]
                : { text: "这一年平安无事" };
        }
        function nextYear() {
            const eventsContainer = document.getElementById('events');
            // 出生事件特殊处理
            if(player.age === -1) {
                player.age = 0;
                const birthEvent = {
                    text: `你出生了，是个${player.gender}！`,
                    effect: {
                        wealth: player.wealth > 10 ? 2 : 0
                    }
                };
                const eventElement = document.createElement('div');
                eventElement.className = 'event';
                eventElement.innerHTML = `<p class="highlight">0岁: ${birthEvent.text}</p>`;
                eventsContainer.appendChild(eventElement);
                // 应用效果
                Object.entries(birthEvent.effect).forEach(([attr, value]) => {
                    player[attr] += value;
                });
                updateStatus();
                eventsContainer.scrollTop = eventsContainer.scrollHeight;
                return;
            }
            player.age++;
            // 正常事件处理...
            const event = generateEvent();
            const eventElement = document.createElement('div');
            eventElement.className = 'event';
            eventElement.innerHTML = `<p class="highlight">${player.age}岁: ${event.text}</p>`;

            eventsContainer.appendChild(eventElement);
            // 自动滚动到底部
            eventsContainer.scrollTop = eventsContainer.scrollHeight;
            // 应用事件效果
            player.looks += event.looks || 0;
            player.intelligence += event.intelligence || 0;
            player.health += event.health || 0;
            player.wealth += event.wealth || 0;
            // 属性最小值限制
            player.health = Math.max(0, player.health);
            player.wealth = Math.max(0, player.wealth);
            updateStatus();
            // 检查游戏结束
            if(checkGameEnd()) {
                endGame();
            }
        }
        function endGame() {
            document.getElementById('game-screen').classList.add('hidden');
            const endScreen = document.getElementById('end-screen');
            endScreen.classList.remove('hidden');
            const summary = `你的人生走到了尽头，享年${player.age}岁。<br>
                最终属性:<br>
                颜值: ${player.looks}<br>
                智力: ${player.intelligence}<br>
                体质: ${player.health}<br>
                家境: ${player.wealth}`;
            document.getElementById('summary').innerHTML = summary;
        }
        // 修改游戏结束检查
        function checkGameEnd() {
            return player.age > player.lifespan || player.health <= 0;
        }
    </script>
</body>
</html>